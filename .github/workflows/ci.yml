name: CI

on:
  push:
  pull_request:

jobs:
  build-and-test:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows: native (AUTO -> SCHANNEL) + forced mbedTLS
          - name: windows-native-schannel
            os: windows-latest
            backend: AUTO
            fetch_mbedtls: "OFF"

          - name: windows-forced-mbedtls
            os: windows-latest
            backend: MBEDTLS
            fetch_mbedtls: "ON"

          # macOS: native (AUTO -> APPLE) + forced mbedTLS
          - name: macos-native-apple
            os: macos-latest
            backend: AUTO
            fetch_mbedtls: "OFF"

          - name: macos-forced-mbedtls
            os: macos-latest
            backend: MBEDTLS
            fetch_mbedtls: "ON"

          # Linux: only mbedTLS needed (native AUTO also resolves to mbedTLS)
          - name: ubuntu-forced-mbedtls
            os: ubuntu-latest
            backend: MBEDTLS
            fetch_mbedtls: "ON"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve Python executable for CMake
        shell: bash
        run: echo "PYTHON_FOR_CMAKE=$(python -c 'import sys; print(sys.executable)')" >> "$GITHUB_ENV"

      - name: Install Python deps for mbedTLS codegen
        if: matrix.fetch_mbedtls == 'ON'
        run: ${{ env.PYTHON_FOR_CMAKE }} -m pip install --upgrade pip jsonschema jinja2

      - name: Configure
        run: >-
          cmake -S . -B build
          -DPython3_EXECUTABLE=${{ env.PYTHON_FOR_CMAKE }}
          -DNATIVE_TLS_SHIM_BACKEND=${{ matrix.backend }}
          -DNATIVE_TLS_SHIM_FETCH_MBEDTLS=${{ matrix.fetch_mbedtls }}
          -DNATIVE_TLS_SHIM_BUILD_TESTS=ON
          -DNATIVE_TLS_SHIM_BUILD_EXAMPLES=ON
          -DNATIVE_TLS_SHIM_ENABLE_INSTALL=OFF
          -DCMAKE_BUILD_TYPE=Debug

      - name: Build
        run: cmake --build build --config Debug --parallel

      - name: Test
        run: >-
          ctest --test-dir build -C Debug --output-on-failure

      - name: Httplib cipher suite check (Windows)
        if: runner.os == 'Windows'
        run: ./build/example/Debug/httplib_example.exe

      - name: Httplib cipher suite check
        if: runner.os != 'Windows'
        run: ./build/example/httplib_example
