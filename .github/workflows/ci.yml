name: CI

on:
  push:
  pull_request:

jobs:
  build-and-test:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows: native (AUTO -> SCHANNEL) + forced mbedTLS
          - name: windows-native-schannel
            os: windows-latest
            backend: AUTO
            fetch_mbedtls: "OFF"
            build_tests: "ON"
            run_tests: "true"

          - name: windows-forced-mbedtls
            os: windows-latest
            backend: MBEDTLS
            fetch_mbedtls: "ON"
            build_tests: "ON"
            run_tests: "true"

          # macOS: native (AUTO -> APPLE, currently placeholder) + forced mbedTLS
          # Native Apple backend is build-only for now.
          - name: macos-native-apple-build-only
            os: macos-latest
            backend: AUTO
            fetch_mbedtls: "OFF"
            build_tests: "OFF"
            run_tests: "false"

          - name: macos-forced-mbedtls
            os: macos-latest
            backend: MBEDTLS
            fetch_mbedtls: "ON"
            build_tests: "ON"
            run_tests: "true"

          # Linux: only mbedTLS needed (native AUTO also resolves to mbedTLS)
          - name: ubuntu-forced-mbedtls
            os: ubuntu-latest
            backend: MBEDTLS
            fetch_mbedtls: "ON"
            build_tests: "ON"
            run_tests: "true"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve Python executable for CMake
        shell: bash
        run: echo "PYTHON_FOR_CMAKE=$(python -c 'import sys; print(sys.executable)')" >> "$GITHUB_ENV"

      - name: Install Python deps for mbedTLS codegen
        if: matrix.fetch_mbedtls == 'ON'
        run: ${{ env.PYTHON_FOR_CMAKE }} -m pip install --upgrade pip jsonschema jinja2

      - name: Configure
        run: >-
          cmake -S . -B build
          -DPython3_EXECUTABLE=${{ env.PYTHON_FOR_CMAKE }}
          -DNATIVE_TLS_SHIM_BACKEND=${{ matrix.backend }}
          -DNATIVE_TLS_SHIM_FETCH_MBEDTLS=${{ matrix.fetch_mbedtls }}
          -DNATIVE_TLS_SHIM_BUILD_TESTS=${{ matrix.build_tests }}
          -DNATIVE_TLS_SHIM_BUILD_EXAMPLES=OFF
          -DNATIVE_TLS_SHIM_ENABLE_INSTALL=OFF
          -DCMAKE_BUILD_TYPE=Debug

      - name: Build
        run: cmake --build build --config Debug --parallel

      - name: Test
        if: matrix.run_tests == 'true'
        run: >-
          ctest --test-dir build -C Debug --output-on-failure
          --exclude-regex test_ixwebsocket_client
